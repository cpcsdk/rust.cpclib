## Purpose
This file gives fast, actionable context for AI coding agents working on this repository so they become productive immediately.

## High-level architecture
- **Workspace layout**: This is a Cargo workspace (see `Cargo.toml`) composed of many crates under the repository root (examples: `cpclib`, `cpclib-asm`, `cpclib-basm`, `cpclib-wasm`, `cpclib-crunchers`, `cpclib-bndbuild`, etc.). Treat `cpclib` as the core library; it embeds most of other crates.
- **Major responsibilities**:
  - `cpclib` — core library for Amstrad CPC demo tooling (assembly helpers, image conversion, DSK manipulation, SNA handling).
  - `cpclib-asm`, `cpclib-basm`, `cpclib-basmdoc` — z80 assembler-related components and docs.
  - `cpclib-bdasm` - z80 disassembler tool and library.
  - `cpclib-wasm` — web/wasm bindings and website assets under `cpclib-wasm/www/`.
  - `cpclib-xfer` / `cpclib-xfertool` — transfer utilities for hardware (cpcwifi/xfer-like functionality).
  - `cpclib-crunch`, `cpclib-crunchers` — crunching utilities that target z80 cpu.
  - `cpclib-bndbuild`, `cpclib-runner` — Demo project automation build tool. This can be seen as a supercharger makefile dedicated to Amstrad CPC democoding..
  - `cpclib-basic` - Utilities to handle Amstrad CPC BASIC files.
  - `cpclib-sna` - Utilities to handle Amstrad CPC SNA files.
  - `cpclib-dic` - Utilities to handle Amstrad CPC DSK files.
  - `cpclib-cpr`, `cpclib-cprcli` - Utilities to handle Amstrad CPC CPR files.
  - `cpclib-image`, `cpclib-image-convert`, `cpclib-sprite-compiler` - Utilities to handle Amstrad CPC image files and conversion.
  - `cpclib-emucontrol` - Utilities to control emulators supporting remote commands.
- **Data flows & integrations**: image conversion → sprite compiler → assembled code; DSK builder writes files used by runner/emulator. 
Many crates exchange domain types rather than raw strings (see `cpclib` src for types and serializers).

## Developer workflows (commands & important scripts)
- **Local build (linux)**: `./build_linux.sh` which runs `cargo build --release --all-features` (workspace release build).
- **Cross-compile macOS from Linux**: `./build_osx_from_linux.sh` (requires `osxcross`; script sets `o64-clang`, `PKG_CONFIG_ALLOW_CROSS=1` and target `x86_64-apple-darwin`).
- **Windows cross-build**: `./build_windows.sh` uses `cargo +nightly build --release --target=i686-pc-windows-gnu --bins`. Note: Windows toolchain must be `nightly-x86_64-pc-windows-gnu` as warned in `Readme.mkd`.
- **Toolchain**: `rust-toolchain.toml` sets `channel = "nightly"`. Use the same toolchain for local development to avoid subtle compat issues.
- **Run tests**: `cargo test --workspace` or `cargo test -p <crate>` to run a specific crate's tests.
- **Docs / site**: Documentation is at https://cpcsdk.github.io/rust.cpclib/ (generated by crate examples/README content and `cpclib-wasm` assets).

## Quickstart (recommended)
- **Setup toolchain** (use nightly for workspace):
```bash
# install nightly and set override for this repo
rustup toolchain install nightly
cd /path/to/rust.cpcdemotools
rustup override set nightly
# add Windows target if you plan to cross-build
rustup target add i686-pc-windows-gnu
```
- **Fast single-crate build / test**:
```bash
# build one crate (example)
cargo build -p cpclib-image --release
# run tests for a single crate
cargo test -p cpclib-basm
```
- **Run a binary (smoke test)**:
```bash
# show help for a CLI binary (example)
cargo run -p cpclib-bndbuild --release -- --help
```
- **osxcross (macOS cross-build) quick hint**:
```bash
export PATH=~/src/osxcross/target/bin:$PATH
export PKG_CONFIG_ALLOW_CROSS=1
export CC=o64-clang
export CXX=o64-clang++
./build_osx_from_linux.sh
```
- **Quick workspace smoke test**:
```bash
# run a small library test suite as a fast smoke check
cargo test -p cpclib --lib
```

## Project-specific conventions
- **Minimal feature sets**: Workspace dependencies in `Cargo.toml` often set `default-features = false`. When adding features keep this pattern in mind and opt into features explicitly.
- **Local patching**: The repo uses `[patch.crates-io]` to reference local crate paths; when adding a new crate, add it to both `members` and `default-members` as appropriate.
- **Build.rs usage**: Many crates include `build.rs` to generate assets/compile-time constants — check the crate root for generated artifacts when editing.
- **Binary outputs**: Tools produce CLI binaries (see bins in `cpclib-*` crates). When changing a CLI, run `cargo build --bins` to validate.

## Naming / file patterns to look for
- `Readme.mkd` or `Readme.md` at crate roots — these contain crate-level intent and examples (e.g. `cpclib/Readme.mkd`, `cpclib-asm/Readme.md`).
- `tests/` directories per crate for unit/integration tests. Use these as canonical examples for API usage.
- `examples/`, `assets/`, `www/` — contain runnable examples and static assets used by tools.

## Integration & external dependencies
- Hardware integration: `cpclib-xfer` and `cpclib-xfertool` interact with physical hardware (cpcwifi). Expect code paths that perform I/O and hardware resets — run tests carefully.
- Third-party tooling: cross-compilation relies on `osxcross` and an i686 Windows GNU toolchain; CI or developer machines must install matching toolchains.

## How to handle common tasks (examples)
- Add a new crate: add path to `Cargo.toml` workspace `members` and `default-members`, add a local `patch.crates-io` entry if you want to override published crate names.
- Update core library API: update `cpclib` first, then run `cargo build --workspace` and `cargo test --workspace` to pick up dependent breakage.
- Debugging produced binaries: build with `cargo build -p <crate>`, then run the binary from the crate `target/debug` or `target/release` folder and provide required example assets from `examples/` or `assets/`.

## What not to change lightly
- The release build profiles and `[patch.crates-io]` layout. Changing these can break local development and CI.
- The advertised toolchain in `Readme.mkd` and `rust-toolchain.toml`. Keep `nightly` for reproducibility.

## Where to look for more context
- Root: `Readme.mkd` for project purpose and links.
- Workspace manifest: `Cargo.toml` for member list, deps and workspace policies.
- Key crate READMEs: `cpclib/Readme.mkd`, `cpclib-asm/Readme.md`, `cpclib-basm/Readme.md`, `cpclib-wasm/README.md`.

If anything here is unclear or you want the instructions to emphasise CI, contributing rules, or to include a short `PR` checklist, tell me which area to expand and I will update this file.
