<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation - {{page.file_name}}</title>
    <!-- Highlight.js for syntax highlighting (embedded for offline use) -->
    <style>
        {{ highlightjs_css | safe }}
    </style>

    <style>
        {{ documentation_css | safe }}
    </style>
</head>
<body>
    <!-- Macro definitions (must be at the top before usage) -->
    
    <!-- Macro for displaying cross-references -->
    {% macro show_references(item) %}
        {% if item.has_references %}
        <div class="cross-references">
            <h5>Referenced in:</h5>
            <ul class="reference-list">
                {% for ref in item.references %}
                <li class="reference-item">
                    <span class="ref-location">{{ ref.source_file }}:{{ ref.line_number }}</span>
                    <pre><code class="language-basm">{{ ref.highlighted_context | safe }}</code></pre>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    {% endmacro %}
    
    <!-- Macro for sidebar section -->
    {% macro sidebar_section(title, id, items) %}
        <div class="sidebar-section" id="sidebar-{{ id }}">
            <h2>{{ title }}</h2>
            <ul>
                {% for item in items %}
                <li class="sidebar-item" data-source-file="{{ item.display_source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                {% endfor %}
            </ul>
        </div>
    {% endmacro %}
    
    <!-- Macro for item header -->
    {% macro item_header(item) %}
        <h4 id="{{item.key}}" class="anchor-offset item-header">
            <span class="item-name">{{ item.summary }}</span>
            {% if item.line_number > 0 %}<span class="ref-location">{{ item.display_source_file }}:{{ item.line_number }}</span>{% endif %}
        </h4>
    {% endmacro %}
    
    <!-- Macro for source code toggle -->
    {% macro source_toggle(item) %}
        {% if item.source %}
        <div class="macro-source">
            <details class="macro-source-details">
                <summary>Show Source</summary>
                {% if item.linked_source %}
                <pre><code class="hljs language-basm">{{ item.linked_source | add_line_numbers(item.line_number) | safe }}</code></pre>
                {% else %}
                <pre><code class="hljs language-basm">{{ item.source | highlight_and_link | add_line_numbers(item.line_number) | safe }}</code></pre>
                {% endif %}
            </details>
        </div>
        {% endif %}
    {% endmacro %}
    
    <!-- Macro for displaying a documented item -->
    {% macro show_item(item, show_source=false) %}
        <div class="item" data-source-file="{{ item.display_source_file }}">
            {{ item_header(item) }}
            <div>{{ item.doc | safe }}</div>
            {% if show_source %}
                {{ source_toggle(item) }}
            {% endif %}
            {{ show_references(item) }}
        </div>
    {% endmacro %}

    <div class="search-container">
        <input type="text" id="searchBox" class="search-box" placeholder="üîç Search documentation..." />
        <button id="clearSearchBtn" class="clear-search-btn" title="Clear search">‚úï</button>
    </div>
    <div class="container">
        <!-- Sidebar with Table of Contents -->
        <aside class="sidebar">
            <h1>üìö BASMDoc</h1>
            <!--<div class="file-name">{{ page.file_name }}</div>-->

            <!-- Symbol Index link -->
            <div class="sidebar-section" id="sidebar-symbol-index">
                <h2><a href="#symbol-index-section" style="color: inherit; text-decoration: none;">üìë Symbol Index</a></h2>
            </div>

            {% if file_list | length > 1 %}
            <div class="sidebar-section" id="sidebar-files">
                <h2>Files</h2>
                <div class="file-tree-header">
                    <a href="#" id="all-files-link" class="file-filter-link active" data-file="">All Files</a>
                </div>
                <details class="file-tree" open>
                    <summary class="file-tree-toggle">üìÅ File Structure</summary>
                    <div id="file-tree-root" class="file-tree-content"></div>
                </details>
                <!-- Hidden list to store file data -->
                <ul id="file-filter-list" style="display: none;">
                    {% for file in file_list %}
                    <li><a href="#" class="file-filter-link" data-file="{{ file }}">{{ file }}</a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if labels|length > 0 %}
                {{ sidebar_section("Labels", "labels", labels) }}
            {% endif %}

            {% if macros|length > 0 %}
                {{ sidebar_section("Macros", "macros", macros) }}
            {% endif %}

            {% if functions|length > 0 %}
                {{ sidebar_section("Functions", "functions", functions) }}
            {% endif %}

            {% if equs|length > 0 %}
                {{ sidebar_section("Equs", "equs", equs) }}
            {% endif %}
        </aside>

        <!-- Main content -->
        <main class="main-content">
        
        <!--
            <div class="file-header">
                <h1>Assembly Documentation</h1>
                <div class="file-name">File: {{ page.file_name }}</div>
            </div>
            -->

            <!-- Symbol Index section -->
            <section class="section" id="symbol-index-section">
                <h2 class="anchor-offset">Symbol Index</h2>
                <div class="index-jump">
                    {% for letter, items in page.symbol_index %}
                    <a href="#index-{{ letter[0] }}" class="jump-link" data-letter="{{ letter[0] }}">{{ letter[0] }}</a>
                    {% endfor %}
                </div>
                
                {% for letter, items in page.symbol_index %}
                <div class="index-letter" id="index-{{ letter[0] }}">
                    <span>{{ letter[0] }}</span>
                </div>
                <div class="index-items">
                    {% for item in items %}
                    <div class="index-item" data-source-file="{{ item.display_source_file }}">
                        <a href="#{{item.key}}">
                            <code>{{ item.short_summary }}</code>
                            {% if item.is_label %}
                            <span class="index-item-type">label</span>
                            {% elif item.is_macro %}
                            <span class="index-item-type">macro</span>
                            {% elif item.is_function %}
                            <span class="index-item-type">function</span>
                            {% elif item.is_equ %}
                            <span class="index-item-type">equ</span>
                            {% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </section>

            <!-- Files section (file-level documentation) -->
            <section class="section">
                <h2 id="files-section" class="anchor-offset">File Documentation</h2>
                {% for file in file_list %}
                    <div class="item" data-source-file="{{ file }}">
                        <!-- Show syntax error if present for this file -->
                        {% for error_item in syntax_errors %}
                            {% if error_item.display_source_file == file %}
                                <div class="syntax-error-box">
                                    <h4 class="syntax-error-title">‚ö†Ô∏è Parse Error</h4>
                                    <pre class="syntax-error-message">{{ error_item.syntax_error_message }}</pre>
                                    <p class="syntax-error-help">The source code below may contain syntax errors. Please review and fix them.</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <h4 id="source_{{ file | replace('/', '_') | replace('.', '_') }}" class="anchor-offset">{{ file }}</h4>
                        <details class="source-details">
                            <summary>Show Source</summary>
                            {% if file_source_map[file] %}
                                <pre><code class="hljs language-basm">{{ file_source_map[file] | highlight_and_link | add_line_numbers(1) | safe }}</code></pre>
                            {% else %}
                                <pre><code class="hljs language-basm">(Source not available)</code></pre>
                            {% endif %}
                        </details>
                    </div>
                {% endfor %}
            </section>

            <!-- Labels section -->
            {% if labels|length > 0 %}
            <section class="section">
                <h2 id="labels-section" class="anchor-offset">Labels</h2>
                {% for item in labels %}
                    {{ show_item(item) }}
                {% endfor %}
            </section>
            {% endif %}

            <!-- Macros section -->
            {% if macros|length > 0 %}
            <section class="section">
                <h2 id="macros-section" class="anchor-offset">Macros</h2>
                {% for item in macros %}
                    {{ show_item(item, show_source=true) }}
                {% endfor %}
            </section>
            {% endif %}

            <!-- Functions section -->
            {% if functions|length > 0 %}
            <section class="section">
                <h2 id="functions-section" class="anchor-offset">Functions</h2>
                {% for item in functions %}
                    {{ show_item(item, show_source=true) }}
                {% endfor %}
            </section>
            {% endif %}

            <!-- Equs section -->
            {% if equs|length > 0 %}
            <section class="section">
                <h2 id="equs-section" class="anchor-offset">Equs</h2>
                {% for item in equs %}
                    {{ show_item(item) }}
                {% endfor %}
            </section>
            {% endif %}
        </main>
    </div>
    <script>{{ documentation_js | safe }}</script>
    <script>
        // Normalize file names when filtering: some items use absolute paths
        // while file-filter links use workspace-relative paths. Wrap the
        // generated `filterByFile` to resolve a matching source-file when
        // necessary.
        (function() {
            if (typeof window.filterByFile !== 'function') return;
            const originalFilter = window.filterByFile;

            function resolveFileNameForFiltering(fileName) {
                if (!fileName) return '';
                console.debug('[doc] resolveFileNameForFiltering input', fileName);
                const items = document.querySelectorAll('.item[data-source-file]');
                const candidates = [];
                for (const it of items) {
                    const sf = it.dataset.sourceFile;
                    if (!sf) continue;
                    candidates.push(sf);
                    if (sf === fileName) {
                        console.debug('[doc] exact match', sf);
                        return sf;
                    }
                    if (sf.endsWith('/' + fileName)) {
                        console.debug('[doc] suffix match with /', sf);
                        return sf;
                    }
                    if (sf.endsWith(fileName)) {
                        console.debug('[doc] suffix match', sf);
                        return sf;
                    }
                }
                // Try looser matching by basename and by normalizing separators/case
                try {
                    const inputBasename = fileName.split('/').pop();
                    const normalizedInput = inputBasename.toLowerCase().replace(/[-\s]/g, '_');
                    for (const sf of candidates) {
                        const candBase = sf.split('/').pop();
                        if (!candBase) continue;
                        if (candBase === inputBasename) {
                            console.debug('[doc] basename exact match', sf);
                            return sf;
                        }
                        const normalizedCand = candBase.toLowerCase().replace(/[-\s]/g, '_');
                        if (normalizedCand === normalizedInput) {
                            console.debug('[doc] basename normalized match', sf);
                            return sf;
                        }
                        // also try removing extension variants (e.g., .asm vs .s)
                        const candNoExt = candBase.replace(/\.[^.]+$/, '');
                        const inputNoExt = inputBasename.replace(/\.[^.]+$/, '');
                        if (candNoExt === inputNoExt) {
                            console.debug('[doc] no-ext match', sf);
                            return sf;
                        }
                    }
                } catch (e) {
                    console.debug('[doc] resolver error', e);
                }
                console.debug('[doc] resolveFileNameForFiltering candidates', candidates.slice(0,20));
                return fileName;
            }

            window.filterByFile = function(fileName) {
                const resolved = resolveFileNameForFiltering(fileName);
                return originalFilter(resolved);
            };
        })();

        // Line number click handler: jump to corresponding line in full source
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[LineNumberClick] Setting up file-aware click handlers...');
            
            // Find the "File Documentation" section which contains full source code for all files
            // The #files-section ID is on the h2, so we need to get its parent section
            const filesSectionHeading = document.querySelector('#files-section');
            if (!filesSectionHeading) {
                console.log('[LineNumberClick] No file documentation heading found');
                return;
            }
            
            const fileDocSection = filesSectionHeading.parentElement;
            if (!fileDocSection) {
                console.log('[LineNumberClick] No file documentation section container found');
                return;
            }
            
            // Build a map of source files to their item containers (we'll query for code blocks later after opening details)
            const fileItems = {};
            fileDocSection.querySelectorAll('.item[data-source-file]').forEach(function(item) {
                const sourceFile = item.getAttribute('data-source-file');
                if (sourceFile) {
                    fileItems[sourceFile] = item;
                    console.log('[LineNumberClick] Mapped file:', sourceFile);
                }
            });
            
            console.log('[LineNumberClick] Found', Object.keys(fileItems).length, 'file items');
            
            // Add click handlers to ALL line numbers in the document
            document.querySelectorAll('.line-number').forEach(function(lineNumber) {
                lineNumber.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lineId = this.getAttribute('id');
                    console.log('[LineNumberClick] Clicked on:', lineId);
                    
                    if (!lineId || !lineId.startsWith('L')) {
                        console.log('[LineNumberClick] Invalid line ID');
                        return;
                    }
                    
                    // Find the parent .item element to get the source file
                    let parentItem = this.closest('.item[data-source-file]');
                    if (!parentItem) {
                        console.log('[LineNumberClick] No parent item with data-source-file found');
                        return;
                    }
                    
                    const sourceFile = parentItem.getAttribute('data-source-file');
                    console.log('[LineNumberClick] Source file:', sourceFile);
                    
                    // Extract line number from ID (e.g., "L172" -> "172")
                    const lineNum = lineId.substring(1);
                    console.log('[LineNumberClick] Looking for line:', lineNum, 'in file:', sourceFile);
                    
                    // Get the item container for this specific file
                    const fileItem = fileItems[sourceFile];
                    if (!fileItem) {
                        console.log('[LineNumberClick] No file item found for:', sourceFile);
                        return;
                    }
                    
                    // Find and open the details element if it exists and is closed
                    const detailsElement = fileItem.querySelector('details.source-details');
                    if (detailsElement && !detailsElement.open) {
                        console.log('[LineNumberClick] Opening details element for file:', sourceFile);
                        detailsElement.open = true;
                    }
                    
                    // Now query for the code block (after opening details, it should be accessible)
                    const fullSourceBlock = fileItem.querySelector('.code-with-line-numbers');
                    if (!fullSourceBlock) {
                        console.log('[LineNumberClick] No full source block found for file:', sourceFile);
                        return;
                    }
                    
                    console.log('[LineNumberClick] Found code block with', fullSourceBlock.querySelectorAll('.line-number').length, 'lines');
                    
                    // Look for the corresponding line in the file's full source section
                    const targetLine = fullSourceBlock.querySelector('.line-number[id="L' + lineNum + '"]');
                    console.log('[LineNumberClick] Target line found:', !!targetLine);
                    
                    if (targetLine) {
                        // Scroll to target with offset for fixed header
                        const yOffset = -80;
                        const y = targetLine.getBoundingClientRect().top + window.pageYOffset + yOffset;
                        console.log('[LineNumberClick] Scrolling to y:', y);
                        window.scrollTo({top: y, behavior: 'smooth'});
                        
                        // Highlight the target line temporarily
                        const codeLine = targetLine.parentElement;
                        if (codeLine) {
                            codeLine.style.backgroundColor = '#fff3cd';
                            codeLine.style.transition = 'background-color 0.3s';
                            setTimeout(function() {
                                codeLine.style.backgroundColor = '';
                            }, 2000);
                        }
                    } else {
                        console.log('[LineNumberClick] Target line L' + lineNum + ' not found in file:', sourceFile);
                    }
                });
            });
            
            console.log('[LineNumberClick] Setup complete. Added handlers to', document.querySelectorAll('.line-number').length, 'line numbers');
        });
    </script>
</body>
</html>
