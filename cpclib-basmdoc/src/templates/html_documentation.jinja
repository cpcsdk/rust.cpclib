<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation - {{page.file_name}}</title>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Custom BASM/Z80 syntax highlighter
        hljs.registerLanguage('basm', function(hljs) {
            return {
                case_insensitive: true,
                keywords: {
                    // Z80 Instructions
                    keyword: 'ADC ADD AND BIT CALL CCF CP CPD CPDR CPI CPIR CPL DAA DEC DI DJNZ EI EX EXA EXX HALT IM IN INC IND INDR INI INIR JP JR LD LDD LDDR LDI LDIR NEG NOP OR OTDR OTIR OUT OUTD OUTI POP PUSH RES RET RETI RETN RL RLA RLC RLCA RLD RR RRA RRC RRCA RRD RST SBC SCF SET SLA SLL SRA SRL SUB XOR',
                    // BASM Directives
                    built_in: 'ABYTE ALIGN ASMCONTROL ASSERT BANK BANKSET BINCLUDE BREAK BREAKPOINT BUILDCPR BUILDSNA BYTE CASE CHARSET DB DEFAULT DEFB DEFM DEFS DEFW DEFSECTION DM DS EVEN FOR DW ELSE ELSEIF ELSEIFDEF ELSEIFEXIST ELSEIFNDEF ELSEIFNOT ELSEIFUSED ENT EQU EXPORT FAIL INCBIN INCLUDE INCLZ4 INCEXO INCL48 INCL49 INCLZSA1 INCLZSA2 INCAPU INCZX0 INCZX0_BACKWARD INCSHRINKLER INCUPKR LET LIMIT LIST LZEXO LZSA1 LZSA2 LZUPKR MAP MODULE NOEXPORT NOLIST ORG OUTPUT PAUSE PRINT PROTECT RANGE READ REND REPEAT REP REPT RORG RETURN RUN SAVE SECTION SNAINIT SNAPINIT SNASET STARTINGINDEX STR TEXT TICKER UNDEF UNTIL WAITNOPS WARNING WORD WRITE ASMCONTROLENV CONFINED FUNCTION IF IFDEF IFEXIST IFNDEF IFNOT IFUSED IFNUSED ITER ITERATE LZ4 LZ48 LZ49 LZAPU LZX0_BACKWARD LZX0 LZSHRINKLER LOCOMOTIVE MACRO PHASE STRUCT SWITCH WHILE END ENDASMCONTROLENV ENDA CEND DEPHASE ENDC ENDCONFINED ENDF ENDFOR ENDFUNCTION ENDI ENDIF ENDITER ENDITERATE ENDM ENDMACRO ENDMODULE ENDR ENDREP ENDREPEAT ENDS ENDSWITCH ENDW ENDWHILE FEND IEND LZCLOSE WEND',
                    // Registers
                    variable: 'AF HL DE BC IX IY IXL IXH A B C D E H L I R SP PC F IXH IXL IYH IYL',
                    // Functions
                    title: 'ABS ACOS ASIN CEIL CHAR COS EXP FLOOR FRAC HI HIGH INT LN LO LOG10 LOW MEMORY PEEK SIN SQRT RND MAX MIN POW'
                },
                contains: [
                    hljs.COMMENT(';', '$', {
                        relevance: 0
                    }),
                    {
                        // Macro/repeat block template variables: {variable_name}
                        className: 'params',
                        begin: '\\{[a-zA-Z_][a-zA-Z0-9_]*\\}',
                        relevance: 10
                    },
                    {
                        className: 'number',
                        variants: [
                            { begin: '\\b0[xX][0-9a-fA-F]+' }, // hex
                            { begin: '\\$[0-9a-fA-F]+' }, // $ hex
                            { begin: '#[0-9a-fA-F]+' }, // # hex  
                            { begin: '&[0-9a-fA-F]+' }, // & hex (CPC style)
                            { begin: '0[bB][01]+' }, // binary
                            { begin: '%[01]+' }, // % binary
                            { begin: '\\b[0-9]+' } // decimal
                        ]
                    },
                    {
                        className: 'string',
                        variants: [
                            { begin: '"', end: '"' },
                            { begin: "'", end: "'" }
                        ]
                    },
                    {
                        className: 'symbol',
                        begin: '^[a-zA-Z_\\.][a-zA-Z0-9_]*:?',
                        relevance: 0
                    },
                    {
                        className: 'meta',
                        begin: '\\.(macro|endmacro|function|endfunction)',
                        relevance: 10
                    }
                ]
            };
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (Table of Contents) */
        .sidebar {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .sidebar h1 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .sidebar h2 {
            font-size: 0.95em;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar ul {
            list-style: none;
            margin-left: 0;
        }

        .sidebar li {
            margin: 4px 0;
        }

        .sidebar a {
            color: #3498db;
            text-decoration: none;
            display: block;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.9em;
        }

        .sidebar a:hover {
            background-color: #e8f4f8;
            color: #2980b9;
        }

        .sidebar a code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
        }

        /* Main content */
        .main-content {
            margin-left: 300px;
            flex: 1;
            padding: 40px 60px;
            background-color: #fff;
            max-width: calc(100% - 300px);
        }

        .main-content h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .main-content h2 {
            font-size: 2em;
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .main-content h3 {
            font-size: 1.5em;
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .main-content h4 {
            font-size: 1.2em;
            color: #666;
            margin-top: 25px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 3px;
        }

        .main-content code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
            color: #e74c3c;
        }

        .main-content pre {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .main-content pre code {
            background-color: transparent;
            padding: 0;
            color: #333;
        }

        /* Custom syntax highlighting colors for BASM template variables */
        .hljs-params {
            color: #e06c75 !important; /* Bright red/pink for template variables like {comment} */
            font-weight: 600;
        }

        .main-content p {
            margin-bottom: 15px;
        }

        .main-content ul, .main-content ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        .main-content li {
            margin-bottom: 8px;
        }

        /* Tables from markdown */
        .main-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .main-content table th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border: 1px solid #2980b9;
        }

        .main-content table td {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
        }

        .main-content table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .main-content table tr:hover {
            background-color: #e8f4f8;
        }

        /* Markdown content inside items */
        .item > div h1,
        .item > div h2,
        .item > div h3 {
            font-size: 1.1em;
            margin-top: 15px;
            margin-bottom: 10px;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }

        .item > div h1:first-child,
        .item > div h2:first-child,
        .item > div h3:first-child {
            margin-top: 0;
        }

        .item > div ul,
        .item > div ol {
            margin-left: 20px;
        }

        .item > div blockquote {
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
            font-style: italic;
        }

        .file-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .file-header h1 {
            border: none;
            color: white;
            margin: 0;
        }

        .file-name {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }

        .section {
            margin-top: 40px;
        }

        .item {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #fafafa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .item h4 {
            margin-top: 0;
        }

        /* Collapsible source code */
        .macro-source {
            margin-top: 15px;
        }

        .macro-source-toggle {
            background-color: #3498db;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .macro-source-toggle:hover {
            background-color: #2980b9;
        }

        .macro-source-toggle::before {
            content: "â–¶";
            display: inline-block;
            transition: transform 0.2s;
        }

        .macro-source-toggle.active::before {
            transform: rotate(90deg);
        }

        .macro-source-content {
            display: none;
            margin-top: 10px;
            background-color: #282c34;
            border-radius: 4px;
            overflow: hidden;
        }

        .macro-source-content.show {
            display: block;
        }

        .macro-source-content pre {
            margin: 0;
            padding: 15px;
            background-color: transparent;
            border: none;
            color: #abb2bf;
            font-size: 0.85em;
            line-height: 1.5;
        }

        .macro-source-content code {
            color: #abb2bf;
            background-color: transparent;
        }

        /* Override main-content code styling for macro source */
        .macro-source-content pre code {
            color: #abb2bf !important;
            background-color: transparent !important;
            padding: 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }

            .main-content {
                margin-left: 250px;
                padding: 20px 30px;
                max-width: calc(100% - 250px);
            }
        }

        @media (max-width: 600px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
                padding: 20px;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Anchor offset for fixed sidebar */
        .anchor-offset {
            padding-top: 20px;
            margin-top: -20px;
        }

        /* Search box */
        .search-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .search-box {
            width: 300px;
            padding: 10px 15px;
            border: 2px solid #3498db;
            border-radius: 20px;
            font-size: 0.95em;
            outline: none;
            transition: box-shadow 0.2s;
            background-color: white;
        }

        .search-box:focus {
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .search-box::placeholder {
            color: #999;
        }

        .item.hidden {
            display: none;
        }

        .item.filtered {
            display: none;
        }

        .sidebar-item.filtered {
            display: none;
        }

        .file-filter-link {
            display: block;
            padding: 6px 10px;
            margin: 2px 0;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }

        .file-filter-link.active {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }

        .file-filter-link:hover {
            background-color: #e8f4f8;
        }

        .file-filter-link.active:hover {
            background-color: #2980b9;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
            display: none;
        }

        .no-results.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="searchBox" class="search-box" placeholder="ðŸ” Search documentation..." />
    </div>
    <div class="container">
        <!-- Sidebar with Table of Contents -->
        <aside class="sidebar">
            <h1>ðŸ“š BASMDoc</h1>
            <!--<div class="file-name">{{ page.file_name }}</div>-->

            {% if page.file_list | length > 1 %}
            <h2>Files</h2>
            <ul id="file-filter-list">
                <li><a href="#" onclick="filterByFile(''); return false;" class="file-filter-link active" data-file="">All Files</a></li>
                {% for file in page.file_list %}
                <li><a href="#" onclick="filterByFile('{{ file }}'); return false;" class="file-filter-link" data-file="{{ file }}">{{ file | basename }}</a></li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if page.has_labels() %}
            <div class="sidebar-section" id="sidebar-labels">
                <h2>Labels</h2>
                <ul>
                    {% for item in page.labels %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if page.has_macros() %}
            <div class="sidebar-section" id="sidebar-macros">
                <h2>Macros</h2>
                <ul>
                    {% for item in page.macros %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if page.has_functions() %}
            <div class="sidebar-section" id="sidebar-functions">
                <h2>Functions</h2>
                <ul>
                    {% for item in page.functions %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if page.has_equ() %}
            <div class="sidebar-section" id="sidebar-equs">
                <h2>Equs</h2>
                <ul>
                    {% for item in page.equs %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </aside>

        <!-- Main content -->
        <main class="main-content">
            <div class="file-header">
                <h1>Assembly Documentation</h1>
                <div class="file-name">File: {{ page.file_name }}</div>
            </div>

            <!-- Files section (file-level documentation) -->
            {% if page.has_files() %}
            <section class="section">
                <h2 id="files-section" class="anchor-offset">File Documentation</h2>
                {% for item in page.files %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset">{{ item.short_summary | basename }}</h4>
                    <div>{{ item.doc | markdown_to_html | safe }}</div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Labels section -->
            {% if page.has_labels() %}
            <section class="section">
                <h2 id="labels-section" class="anchor-offset">Labels</h2>
                {% for item in page.labels %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset">{{ item.summary }}</h4>
                    <div>{{ item.doc | markdown_to_html | safe }}</div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Macros section -->
            {% if page.has_macros() %}
            <section class="section">
                <h2 id="macros-section" class="anchor-offset">Macros</h2>
                {% for item in page.macros %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset">{{ item.summary }}</h4>
                    <div>{{ item.doc | markdown_to_html | safe }}</div>
                    {% if item.source %}
                    <div class="macro-source">
                        <button class="macro-source-toggle" onclick="toggleSource('{{item.key}}_source')">View Source</button>
                        <div id="{{item.key}}_source" class="macro-source-content">
                            <pre><code class="language-basm">{{ item.source }}</code></pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Functions section -->
            {% if page.has_functions() %}
            <section class="section">
                <h2 id="functions-section" class="anchor-offset">Functions</h2>
                {% for item in page.functions %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset">{{ item.summary }}</h4>
                    <div>{{ item.doc | markdown_to_html | safe }}</div>
                    {% if item.source %}
                    <div class="macro-source">
                        <button class="macro-source-toggle" onclick="toggleSource('{{item.key}}_source')">View Source</button>
                        <div id="{{item.key}}_source" class="macro-source-content">
                            <pre><code class="language-basm">{{ item.source }}</code></pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Equs section -->
            {% if page.has_equ() %}
            <section class="section">
                <h2 id="equs-section" class="anchor-offset">Equs</h2>
                {% for item in page.equs %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset">{{ item.summary }}</h4>
                    <div>{{ item.doc | markdown_to_html | safe }}</div>
                </div>
                {% endfor %}
            </section>
            {% endif %}
        </main>
    </div>
    <script>
        function toggleSource(id) {
            const content = document.getElementById(id);
            const button = event.target;
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                button.classList.remove('active');
            } else {
                content.classList.add('show');
                button.classList.add('active');
                // Highlight the code when shown
                const codeBlock = content.querySelector('code');
                if (codeBlock && !codeBlock.dataset.highlighted) {
                    hljs.highlightElement(codeBlock);
                }
            }
        }

        // File filtering functionality
        function filterByFile(fileName) {
            const items = document.querySelectorAll('.item');
            const sections = document.querySelectorAll('.section');
            const fileLinks = document.querySelectorAll('.file-filter-link');
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const sidebarSections = document.querySelectorAll('.sidebar-section');
            
            // Update active link
            fileLinks.forEach(link => {
                if (link.dataset.file === fileName) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            
            // Scroll to file documentation if filtering by specific file
            if (fileName !== '') {
                const fileAnchorId = 'file_' + fileName.replace(/[\/\\.]/g, '_');
                const fileAnchor = document.getElementById(fileAnchorId);
                if (fileAnchor) {
                    setTimeout(() => {
                        fileAnchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }
            
            // Filter sidebar items and hide empty sections
            sidebarSections.forEach(sidebarSection => {
                let visibleSidebarCount = 0;
                const sidebarSectionItems = sidebarSection.querySelectorAll('.sidebar-item');
                
                sidebarSectionItems.forEach(item => {
                    const itemFile = item.dataset.sourceFile;
                    
                    if (fileName === '' || itemFile === fileName) {
                        item.classList.remove('filtered');
                        visibleSidebarCount++;
                    } else {
                        item.classList.add('filtered');
                    }
                });
                
                // Hide sidebar section if no visible items
                if (visibleSidebarCount === 0) {
                    sidebarSection.style.display = 'none';
                } else {
                    sidebarSection.style.display = 'block';
                }
            });
            
            // Filter main content items
            sections.forEach(section => {
                let visibleCount = 0;
                const sectionItems = section.querySelectorAll('.item');
                
                sectionItems.forEach(item => {
                    const itemFile = item.dataset.sourceFile;
                    
                    if (fileName === '' || itemFile === fileName) {
                        item.classList.remove('filtered');
                        visibleCount++;
                    } else {
                        item.classList.add('filtered');
                    }
                });
                
                // Show/hide section based on whether it has visible items
                if (visibleCount === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                }
            });
        }

        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchBox = document.getElementById('searchBox');
            const items = document.querySelectorAll('.item');
            const sections = document.querySelectorAll('.section');
            
            searchBox.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                sections.forEach(section => {
                    let visibleCount = 0;
                    const sectionItems = section.querySelectorAll('.item');
                    
                    sectionItems.forEach(item => {
                        // Skip if already filtered by file
                        if (item.classList.contains('filtered')) {
                            return;
                        }
                        
                        const title = item.querySelector('h4').textContent.toLowerCase();
                        const content = item.textContent.toLowerCase();
                        
                        if (searchTerm === '' || title.includes(searchTerm) || content.includes(searchTerm)) {
                            item.classList.remove('hidden');
                            visibleCount++;
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                    
                    // Show/hide section based on whether it has visible items
                    if (visibleCount === 0 && searchTerm !== '') {
                        section.style.display = 'none';
                    } else {
                        section.style.display = 'block';
                    }
                });
                
                // Check if any items are visible
                const visibleItems = document.querySelectorAll('.item:not(.hidden):not(.filtered)');
                const noResultsMsg = document.querySelector('.no-results');
                
                if (visibleItems.length === 0 && searchTerm !== '') {
                    if (!noResultsMsg) {
                        const msg = document.createElement('div');
                        msg.className = 'no-results visible';
                        msg.textContent = 'No results found for "' + searchTerm + '"';
                        document.querySelector('.main-content').appendChild(msg);
                    } else {
                        noResultsMsg.textContent = 'No results found for "' + searchTerm + '"';
                        noResultsMsg.classList.add('visible');
                    }
                } else if (noResultsMsg) {
                    noResultsMsg.classList.remove('visible');
                }
            });
            
            // Initialize syntax highlighting
            hljs.highlightAll();
        });
    </script>
</body>
</html>
