<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation - {{page.file_name}}</title>
    <!-- Highlight.js for syntax highlighting (embedded for offline use) -->
    <style>
        {{ highlightjs_css | safe }}
    </style>

    <style>
        {{ documentation_css | safe }}
    </style>
</head>
<body>
    <!-- Macro definitions (must be at the top before usage) -->
    
    <!-- Macro for displaying cross-references -->
    {% macro show_references(item) %}
        {% if item.has_references %}
        <div class="cross-references">
            <h5>Referenced in:</h5>
            <ul class="reference-list">
                {% for ref in item.references %}
                <li class="reference-item">
                    <span class="ref-location">{{ ref.source_file }}:{{ ref.line_number }}</span>
                    <pre><code class="language-basm">{{ ref.highlighted_context | safe }}</code></pre>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    {% endmacro %}
    
    <!-- Macro for sidebar section -->
    {% macro sidebar_section(title, id, items) %}
        <div class="sidebar-section" id="sidebar-{{ id }}">
            <h2>{{ title }}</h2>
            <ul>
                {% for item in items %}
                <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                {% endfor %}
            </ul>
        </div>
    {% endmacro %}
    
    <!-- Macro for item header -->
    {% macro item_header(item) %}
        <h4 id="{{item.key}}" class="anchor-offset item-header">
            <span class="item-name">{{ item.summary }}</span>
            {% if item.line_number > 0 %}<span class="ref-location">{{ item.source_file }}:{{ item.line_number }}</span>{% endif %}
        </h4>
    {% endmacro %}
    
    <!-- Macro for source code toggle -->
    {% macro source_toggle(item) %}
        {% if item.source %}
        <div class="macro-source">
            <button class="macro-source-toggle" onclick="toggleSource('{{item.key}}_source')">View Source</button>
            <div id="{{item.key}}_source" class="macro-source-content">
                <pre><code class="language-basm">{{ item.source | safe }}</code></pre>
            </div>
        </div>
        {% endif %}
    {% endmacro %}
    
    <!-- Macro for displaying a documented item -->
    {% macro show_item(item, show_source=false) %}
        <div class="item" data-source-file="{{ item.source_file }}">
            {{ item_header(item) }}
            <div>{{ item.doc | markdown_to_html | auto_link_symbols | safe }}</div>
            {% if show_source %}
                {{ source_toggle(item) }}
            {% endif %}
            {{ show_references(item) }}
        </div>
    {% endmacro %}

    <div class="search-container">
        <input type="text" id="searchBox" class="search-box" placeholder="ðŸ” Search documentation..." />
        <button id="clearSearchBtn" class="clear-search-btn" title="Clear search">âœ•</button>
    </div>
    <div class="container">
        <!-- Sidebar with Table of Contents -->
        <aside class="sidebar">
            <h1>ðŸ“š BASMDoc</h1>
            <!--<div class="file-name">{{ page.file_name }}</div>-->

            <!-- Symbol Index link -->
            <div class="sidebar-section" id="sidebar-symbol-index">
                <h2><a href="#symbol-index-section" style="color: inherit; text-decoration: none;">ðŸ“‘ Symbol Index</a></h2>
            </div>

            {% if page.file_list | length > 1 %}
            <h2>Files</h2>
            <ul id="file-filter-list">
                <li><a href="#" onclick="filterByFile(''); return false;" class="file-filter-link active" data-file="">All Files</a></li>
                {% for file in page.file_list %}
                <li><a href="#" onclick="filterByFile('{{ file }}'); return false;" class="file-filter-link" data-file="{{ file }}">{{ file }}</a></li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if page.has_labels() %}
                {{ sidebar_section("Labels", "labels", page.labels) }}
            {% endif %}

            {% if page.has_macros() %}
                {{ sidebar_section("Macros", "macros", page.macros) }}
            {% endif %}

            {% if page.has_functions() %}
                {{ sidebar_section("Functions", "functions", page.functions) }}
            {% endif %}

            {% if page.has_equ() %}
                {{ sidebar_section("Equs", "equs", page.equs) }}
            {% endif %}
        </aside>

        <!-- Main content -->
        <main class="main-content">
        
        <!--
            <div class="file-header">
                <h1>Assembly Documentation</h1>
                <div class="file-name">File: {{ page.file_name }}</div>
            </div>
            -->

            <!-- Symbol Index section -->
            <section class="section" id="symbol-index-section">
                <h2 class="anchor-offset">Symbol Index</h2>
                <div class="index-jump">
                    {% for letter, items in page.symbol_index %}
                    <a href="#index-{{ letter[0] }}" class="jump-link" data-letter="{{ letter[0] }}">{{ letter[0] }}</a>
                    {% endfor %}
                </div>
                
                {% for letter, items in page.symbol_index %}
                <div class="index-letter" id="index-{{ letter[0] }}">
                    <span>{{ letter[0] }}</span>
                </div>
                <div class="index-items">
                    {% for item in items %}
                    <div class="index-item" data-source-file="{{ item.source_file }}">
                        <a href="#{{item.key}}">
                            <code>{{ item.short_summary }}</code>
                            {% if item.is_label %}
                            <span class="index-item-type">label</span>
                            {% elif item.is_macro %}
                            <span class="index-item-type">macro</span>
                            {% elif item.is_function %}
                            <span class="index-item-type">function</span>
                            {% elif item.is_equ %}
                            <span class="index-item-type">equ</span>
                            {% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </section>

            <!-- Files section (file-level documentation) -->
            {% if page.has_files() %}
            <section class="section">
                <h2 id="files-section" class="anchor-offset">File Documentation</h2>
                {% for item in page.files %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset">{{ item.short_summary | basename }}</h4>
                    <div>{{ item.doc | markdown_to_html | safe }}</div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Labels section -->
            {% if page.has_labels() %}
            <section class="section">
                <h2 id="labels-section" class="anchor-offset">Labels</h2>
                {% for item in page.labels %}
                    {{ show_item(item) }}
                {% endfor %}
            </section>
            {% endif %}

            <!-- Macros section -->
            {% if page.has_macros() %}
            <section class="section">
                <h2 id="macros-section" class="anchor-offset">Macros</h2>
                {% for item in page.macros %}
                    {{ show_item(item, show_source=true) }}
                {% endfor %}
            </section>
            {% endif %}

            <!-- Functions section -->
            {% if page.has_functions() %}
            <section class="section">
                <h2 id="functions-section" class="anchor-offset">Functions</h2>
                {% for item in page.functions %}
                    {{ show_item(item, show_source=true) }}
                {% endfor %}
            </section>
            {% endif %}

            <!-- Equs section -->
            {% if page.has_equ() %}
            <section class="section">
                <h2 id="equs-section" class="anchor-offset">Equs</h2>
                {% for item in page.equs %}
                    {{ show_item(item) }}
                {% endfor %}
            </section>
            {% endif %}
        </main>
    </div>
    <script>{{ documentation_js | safe }}</script>
</body>
</html>
