<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation - {{page.file_name}}</title>
    <!-- Highlight.js for syntax highlighting (embedded for offline use) -->
    <style>
        {{ highlightjs_css | safe }}
    </style>
    <script>
        {{ highlightjs | safe }}
    </script>
    <script>
        // Custom BASM/Z80 syntax highlighter
        hljs.registerLanguage('basm', function(hljs) {
            return {
                case_insensitive: true,
                keywords: {
                    // Z80 Instructions (generated from cpclib-asm)
                    keyword: '{{ syntax_instructions }}',
                    // BASM Directives (generated from cpclib-asm)
                    built_in: '{{ syntax_directives }}',
                    // Registers
                    variable: 'AF HL DE BC IX IY IXL IXH A B C D E H L I R SP PC F IYH IYL',
                    // Functions
                    title: 'ABS ACOS ASIN CEIL CHAR COS EXP FLOOR FRAC HI HIGH INT LN LO LOG10 LOW MEMORY PEEK SIN SQRT RND MAX MIN POW'
                },
                contains: [
                    hljs.COMMENT(';', '$', {
                        relevance: 0
                    }),
                    {
                        // Macro/repeat block template variables: {variable_name}
                        className: 'params',
                        begin: '\\{[a-zA-Z_][a-zA-Z0-9_]*\\}',
                        relevance: 10
                    },
                    {
                        className: 'number',
                        variants: [
                            { begin: '\\b0[xX][0-9a-fA-F]+' }, // hex
                            { begin: '\\$[0-9a-fA-F]+' }, // $ hex
                            { begin: '#[0-9a-fA-F]+' }, // # hex  
                            { begin: '&[0-9a-fA-F]+' }, // & hex (CPC style)
                            { begin: '0[bB][01]+' }, // binary
                            { begin: '%[01]+' }, // % binary
                            { begin: '\\b[0-9]+' } // decimal
                        ]
                    },
                    {
                        className: 'string',
                        variants: [
                            { begin: '"', end: '"' },
                            { begin: "'", end: "'" }
                        ]
                    },
                    {
                        className: 'symbol',
                        begin: '^[a-zA-Z_\\.][a-zA-Z0-9_]*:?',
                        relevance: 0
                    },
                    {
                        className: 'meta',
                        begin: '\\.(macro|endmacro|function|endfunction)',
                        relevance: 10
                    }
                ]
            };
        });
    </script>
    <style>
        {{ documentation_css | safe }}
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="searchBox" class="search-box" placeholder="ðŸ” Search documentation..." />
        <button id="clearSearchBtn" class="clear-search-btn" title="Clear search">âœ•</button>
    </div>
    <div class="container">
        <!-- Sidebar with Table of Contents -->
        <aside class="sidebar">
            <h1>ðŸ“š BASMDoc</h1>
            <!--<div class="file-name">{{ page.file_name }}</div>-->

            <!-- Symbol Index link -->
            <div class="sidebar-section" id="sidebar-symbol-index">
                <h2><a href="#symbol-index-section" style="color: inherit; text-decoration: none;">ðŸ“‘ Symbol Index</a></h2>
            </div>

            {% if page.file_list | length > 1 %}
            <h2>Files</h2>
            <ul id="file-filter-list">
                <li><a href="#" onclick="filterByFile(''); return false;" class="file-filter-link active" data-file="">All Files</a></li>
                {% for file in page.file_list %}
                <li><a href="#" onclick="filterByFile('{{ file }}'); return false;" class="file-filter-link" data-file="{{ file }}">{{ file }}</a></li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if page.has_labels() %}
            <div class="sidebar-section" id="sidebar-labels">
                <h2>Labels</h2>
                <ul>
                    {% for item in page.labels %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if page.has_macros() %}
            <div class="sidebar-section" id="sidebar-macros">
                <h2>Macros</h2>
                <ul>
                    {% for item in page.macros %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if page.has_functions() %}
            <div class="sidebar-section" id="sidebar-functions">
                <h2>Functions</h2>
                <ul>
                    {% for item in page.functions %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if page.has_equ() %}
            <div class="sidebar-section" id="sidebar-equs">
                <h2>Equs</h2>
                <ul>
                    {% for item in page.equs %}
                    <li class="sidebar-item" data-source-file="{{ item.source_file }}"><a href="#{{item.key}}"><code>{{ item.short_summary }}</code></a></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </aside>

        <!-- Main content -->
        <main class="main-content">
        
        <!-- Macro for displaying cross-references -->
        {% macro show_references(item) %}
            {% if item.has_references %}
            <div class="cross-references">
                <h5>Referenced in:</h5>
                <ul class="reference-list">
                    {% for ref in item.references %}
                    <li class="reference-item">
                        <span class="ref-location">{{ ref.source_file | basename }}:{{ ref.line_number }}</span>
                        <code class="ref-context">{{ ref.context }}</code>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        {% endmacro %}
        
        <!--
            <div class="file-header">
                <h1>Assembly Documentation</h1>
                <div class="file-name">File: {{ page.file_name }}</div>
            </div>
            -->

            <!-- Symbol Index section -->
            <section class="section" id="symbol-index-section">
                <h2 class="anchor-offset">Symbol Index</h2>
                <div class="index-jump">
                    {% for letter, items in page.symbol_index %}
                    <a href="#index-{{ letter[0] }}" class="jump-link" data-letter="{{ letter[0] }}">{{ letter[0] }}</a>
                    {% endfor %}
                </div>
                
                {% for letter, items in page.symbol_index %}
                <div class="index-letter" id="index-{{ letter[0] }}">
                    <span>{{ letter[0] }}</span>
                </div>
                <div class="index-items">
                    {% for item in items %}
                    <div class="index-item" data-source-file="{{ item.source_file }}">
                        <a href="#{{item.key}}">
                            <code>{{ item.short_summary }}</code>
                            {% if item.is_label %}
                            <span class="index-item-type">label</span>
                            {% elif item.is_macro %}
                            <span class="index-item-type">macro</span>
                            {% elif item.is_function %}
                            <span class="index-item-type">function</span>
                            {% elif item.is_equ %}
                            <span class="index-item-type">equ</span>
                            {% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </section>

            <!-- Files section (file-level documentation) -->
            {% if page.has_files() %}
            <section class="section">
                <h2 id="files-section" class="anchor-offset">File Documentation</h2>
                {% for item in page.files %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset">{{ item.short_summary | basename }}</h4>
                    <div>{{ item.doc | markdown_to_html | safe }}</div>
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Labels section -->
            {% if page.has_labels() %}
            <section class="section">
                <h2 id="labels-section" class="anchor-offset">Labels</h2>
                {% for item in page.labels %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset item-header">
                        <span class="item-name">{{ item.summary }}</span>
                        {% if item.line_number > 0 %}<span class="ref-location">{{ item.source_file }}:{{ item.line_number }}</span>{% endif %}
                    </h4>
                    <div>{{ item.doc | markdown_to_html | auto_link_symbols | safe }}</div>
                    {{ show_references(item) }}
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Macros section -->
            {% if page.has_macros() %}
            <section class="section">
                <h2 id="macros-section" class="anchor-offset">Macros</h2>
                {% for item in page.macros %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset item-header">
                        <span class="item-name">{{ item.summary }}</span>
                        {% if item.line_number > 0 %}<span class="ref-location">{{ item.source_file }}:{{ item.line_number }}</span>{% endif %}
                    </h4>
                    <div>{{ item.doc | markdown_to_html | auto_link_symbols | safe }}</div>
                    {% if item.source %}
                    <div class="macro-source">
                        <button class="macro-source-toggle" onclick="toggleSource('{{item.key}}_source')">View Source</button>
                        <div id="{{item.key}}_source" class="macro-source-content">
                            <pre><code class="language-basm">{{ item.source }}</code></pre>
                        </div>
                    </div>
                    {% endif %}
                    {{ show_references(item) }}
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Functions section -->
            {% if page.has_functions() %}
            <section class="section">
                <h2 id="functions-section" class="anchor-offset">Functions</h2>
                {% for item in page.functions %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset item-header">
                        <span class="item-name">{{ item.summary }}</span>
                        {% if item.line_number > 0 %}<span class="ref-location">{{ item.source_file }}:{{ item.line_number }}</span>{% endif %}
                    </h4>
                    <div>{{ item.doc | markdown_to_html | auto_link_symbols | safe }}</div>
                    {% if item.source %}
                    <div class="macro-source">
                        <button class="macro-source-toggle" onclick="toggleSource('{{item.key}}_source')">View Source</button>
                        <div id="{{item.key}}_source" class="macro-source-content">
                            <pre><code class="language-basm">{{ item.source }}</code></pre>
                        </div>
                    </div>
                    {% endif %}
                    {{ show_references(item) }}
                </div>
                {% endfor %}
            </section>
            {% endif %}

            <!-- Equs section -->
            {% if page.has_equ() %}
            <section class="section">
                <h2 id="equs-section" class="anchor-offset">Equs</h2>
                {% for item in page.equs %}
                <div class="item" data-source-file="{{ item.source_file }}">
                    <h4 id="{{item.key}}" class="anchor-offset item-header">
                        <span class="item-name">{{ item.summary }}</span>
                        {% if item.line_number > 0 %}<span class="ref-location">{{ item.source_file }}:{{ item.line_number }}</span>{% endif %}
                    </h4>
                    <div>{{ item.doc | markdown_to_html | auto_link_symbols | safe }}</div>
                    {{ show_references(item) }}
                </div>
                {% endfor %}
            </section>
            {% endif %}
        </main>
    </div>
    <script>{{ documentation_js | safe }}</script>
</body>
</html>
